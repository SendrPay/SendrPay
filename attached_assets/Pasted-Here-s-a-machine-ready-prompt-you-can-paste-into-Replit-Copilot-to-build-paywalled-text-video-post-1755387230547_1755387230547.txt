Hereâ€™s a machine-ready prompt you can paste into Replit/Copilot to build paywalled text + video posts in a Telegram KOL Channel. Itâ€™s Telegram-only, uses inline buttons, supports SOL + USDC, and delivers unlocked content by DM with a per-user watermark (so the channel never exposes the full post).

â¸»

Build Prompt â€” â€œChannel Paywall (Text + Video)â€

Objective
Add a â€œpay to unlockâ€ system for KOL Channel posts. A post has a public teaser in the channel and an Unlock button. After payment, the buyer gets the full text or video via DM, watermarked with their @username, channel name, and a short txn id. Fees: default 2% on tips, 5% on unlocks (receiver pays). Keep existing P2P/tips untouched.

Stack/assumptions
	â€¢	Node + TypeScript + Telegraf v4 + Express webhook (Telegram only).
	â€¢	Env: TG_BOT_TOKEN, PUBLIC_URL, PORT.
	â€¢	Core you already have: wallet + intents:
	â€¢	createPaymentIntent({flow, payerTgId, receiverTgId, amount, token, feeMode})
	â€¢	waitForIntent(intentId) â†’ { success, explorer, amount, token, payerTgId, receiverTgId }
	â€¢	Fee mode for paywall = "receiver".
	â€¢	Storage: Prisma or similar DB.

â¸»

1) Data models (Prisma-style)

model KolChannel {
  tgChatId            String @id          // channel id
  ownerTgId           String
  defaultToken        String              // "USDC" | "SOL"
  defaultPrice        Decimal             // per-post fallback
  tipPresets          String              // JSON "[1,5,10]"
  isActive            Boolean @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model LockedPost {
  id                  Int     @id @default(autoincrement())
  tgChatId            String           // FK -> KolChannel
  channelMsgId        String           // message id of the teaser in channel
  contentType         String           // "text" | "video"
  priceAmount         Decimal
  priceToken          String           // "USDC" | "SOL"
  payloadRef          String           // text blob id or video file_id (or CDN key)
  title               String?          // optional display title
  createdAt           DateTime @default(now())
}

model PostAccess {
  id                  Int     @id @default(autoincrement())
  postId              Int              // FK -> LockedPost
  userTgId            String
  grantedAt           DateTime @default(now())
  txnRef              String?          // short intent id / sig
  @@unique([postId, userTgId])         // prevent duplicate purchase
}


â¸»

2) Admin/KOL setup & posting

Add admin commands in KOL DM:
	â€¢	/channel_init â†’ KOL forwards any message from their Channel.
	â€¢	Validate bot is admin with post/edit rights.
	â€¢	Ask defaults: defaultToken, defaultPrice, tipPresets.
	â€¢	Upsert KolChannel.
	â€¢	/post_locked (wizard):
	1.	Ask content type: Text or Video.
	2.	If Text â†’ ask for title (optional) then full text (markdown supported).
If Video â†’ ask KOL to upload video (weâ€™ll capture file_id).
	3.	Ask price + token (or use channel defaults).
	4.	Create LockedPost with payloadRef =
	â€¢	text: store in DB (or files table);
	â€¢	video: Telegram file_id (or your CDN key).
	5.	Post teaser to Channel with Unlock and Tip buttons.

Teaser formatting (Channel post)

{title or "Premium post"} 
â€” teaser/preview â€”
Unlock to view full {text|video}.

Inline keyboard (JSON)

{
  "inline_keyboard": [
    [{ "text": "ğŸ”“ Unlock ({{price}} {{token}})", "callback_data": "unlock:{{postId}}" }],
    [{ "text": "ğŸ’– Tip", "callback_data": "tip_open:{{kolTgId}}" }]
  ]
}


â¸»

3) Buyer flow (Unlock)

Handlers in src/paywall/inline.ts:
	â€¢	unlock:<postId>
	â€¢	Fetch LockedPost, render confirm:
â€œUnlock {title or Post #} for {amount token}. Creator covers a small platform fee.â€
	â€¢	Buttons: âœ… Pay now â†’ unlock_go:<postId> | âœ–ï¸ Cancel.
	â€¢	unlock_go:<postId>
	â€¢	Create intent:

createPaymentIntent({
  flow: "post_unlock",
  payerTgId: ctx.from.id,
  receiverTgId: channel.ownerTgId,
  amount: post.priceAmount,
  token: post.priceToken,
  feeMode: "receiver"
})


	â€¢	Edit message: show deeplink + Iâ€™ve paid button â†’ unlock_chk:<intentId>:<postId>.

	â€¢	unlock_chk:<intentId>:<postId>
	â€¢	Call waitForIntent. If pending â†’ show â€œğŸ” Check againâ€.
	â€¢	On success: upsert PostAccess(user, post) with txnRef.
	â€¢	Deliver content by DM (not in channel):
	â€¢	Watermark string: @{username} â€¢ {channelName} â€¢ {date} â€¢ {txnShort}.
	â€¢	If text: send as Markdown message with \n\nâ€” {watermark}.
	â€¢	If video: resend via sendVideo using the stored file_id, with caption = watermark.
(If you host files yourself, generate a signed, short-lived URL and send as link + preview.)
	â€¢	Reply in-channel to user (or edit original button message) with:
â€œâœ… Unlocked. Check your DM.â€
	â€¢	Creator DM:
â€œğŸ”“ Post unlocked by @{buyer}: {amount token}. Tx: {explorer}â€.

Revisit behavior
	â€¢	If buyer taps Unlock again on the same post â†’ detect PostAccess and show â€œYou already unlocked this â€” Resend to DMâ€ with a Resend button.

â¸»

4) Tip panel in channel
	â€¢	tip_open:<kolTgId> â†’ show presets from KolChannel.tipPresets + Custom (token selector: SOL/USDC if both allowed).
	â€¢	On confirm â†’ createPaymentIntent({ flow:'tip', feeMode:'receiver', ... }).
	â€¢	Success â†’ buyer â€œâœ… Tip sentâ€, creator DM â€œğŸ’¸ Tip received â€¦â€.

(Preserves your existing tip logic; reuses buttons inside channel.)

â¸»

5) Anti-leak (best-effort)
	â€¢	Per-buyer watermark on all delivered content.
	â€¢	Channel never holds full content; only teasers exist there.
	â€¢	Optional: generate expiring links for externally hosted videos (e.g., 1â€“24h signed URLs).
	â€¢	Log every resend (rate-limit resends to prevent scraping).

â¸»

6) Copy strings
	â€¢	Confirm unlock:
Youâ€™re unlocking **{title}** for **{amt} {token}**.\n<i>Creator covers a small platform fee.</i>
	â€¢	Pending: â³ Waiting for confirmationâ€¦
	â€¢	Success (buyer): âœ… Unlocked! Iâ€™ve sent it to your DM.
	â€¢	Success (creator): ğŸ”“ {title} unlocked by @{user}: {amt} {token}.
	â€¢	Already purchased: You already own this. Want me to resend it to your DM?

â¸»

7) Acceptance criteria
	â€¢	/channel_init stores channel & defaults; /post_locked publishes a teaser with working buttons.
	â€¢	Payment â†’ DM delivery (text or video) with visible watermark.
	â€¢	PostAccess prevents double-charge; Resend works.
	â€¢	Fees on unlocks = 5% receiver-pays; tips = 2% receiver-pays; P2P unchanged.
	â€¢	All handlers idempotent; Telegram runs in webhook mode only.

â¸»

8) Minimal handler skeletons (TypeScript)

// src/paywall/inline.ts
import { Telegraf, Context } from "telegraf";
import { db } from "../db";
import { createPaymentIntent, waitForIntent } from "../core/payments";
import { fmtPrice, wmString } from "./util";

export function registerPaywall(bot: Telegraf<Context>) {
  bot.action(/^unlock:(\d+)$/, async (ctx) => {
    const postId = Number(ctx.match![1]);
    const post = await db.lockedPost.findUnique({ where: { id: postId }, include: { channel: true }});
    if (!post) return ctx.answerCbQuery("Post not found", { show_alert: true });

    const kb = { inline_keyboard: [[
      { text: `âœ… Pay ${fmtPrice(post)}`, callback_data: `unlock_go:${postId}` },
      { text: "âœ–ï¸ Cancel", callback_data: "cancel" }
    ]]};
    await ctx.editMessageText(
      `Youâ€™re unlocking <b>${post.title ?? `Post #${postId}`}</b> for <b>${fmtPrice(post)}</b>.\n<i>Creator covers a small platform fee.</i>`,
      { parse_mode: "HTML", reply_markup: kb }
    );
  });

  bot.action(/^unlock_go:(\d+)$/, async (ctx) => {
    const postId = Number(ctx.match![1]);
    const post = await db.lockedPost.findUnique({ where: { id: postId }, include: { channel: true }});
    if (!post) return ctx.answerCbQuery("Missing post", { show_alert: true });

    const intent = await createPaymentIntent({
      flow: "post_unlock",
      payerTgId: String(ctx.from!.id),
      receiverTgId: post.channel.ownerTgId,
      amount: String(post.priceAmount),
      token: post.priceToken as any,
      feeMode: "receiver"
    });

    const kb = { inline_keyboard: [[
      { text: "Iâ€™ve paid", callback_data: `unlock_chk:${intent.id}:${postId}` },
      { text: "âœ–ï¸ Cancel", callback_data: "cancel" }
    ]]};
    await ctx.editMessageText(
      `Pay <b>${fmtPrice(post)}</b> to unlock.\nPayment ID: <code>${intent.id.slice(0,8)}</code>\n${intent.deepLink}`,
      { parse_mode: "HTML", reply_markup: kb, disable_web_page_preview: true }
    );
  });

  bot.action(/^unlock_chk:([A-Za-z0-9_-]+):(\d+)$/, async (ctx) => {
    const [intentId, postIdStr] = [ctx.match![1], ctx.match![2]];
    const postId = Number(postIdStr);
    const res = await waitForIntent(intentId);
    if (!res?.success) {
      return ctx.editMessageText("â³ Still pendingâ€¦", { reply_markup: { inline_keyboard: [[
        { text: "ğŸ” Check again", callback_data: `unlock_chk:${intentId}:${postId}` }
      ]] }});
    }

    // grant access
    await db.postAccess.upsert({
      where: { postId_userTgId: { postId, userTgId: String(ctx.from!.id) } },
      update: { txnRef: res.explorer },
      create: { postId, userTgId: String(ctx.from!.id), txnRef: res.explorer }
    });

    // deliver by DM
    const post = await db.lockedPost.findUnique({ where: { id: postId }, include: { channel: true }});
    const wm = wmString(ctx.from!, post!.channel.tgChatId, res.explorer);
    try {
      if (post!.contentType === "text") {
        await ctx.telegram.sendMessage(ctx.from!.id, `${post!.title ? `ğŸ“ <b>${post!.title}</b>\n\n` : ""}${post!.payloadRef}\n\nâ€” ${wm}`, { parse_mode: "HTML" });
      } else {
        await ctx.telegram.sendVideo(ctx.from!.id, post!.payloadRef, { caption: `â€” ${wm}` });
      }
    } catch {}

    await ctx.editMessageText("âœ… Unlocked. Check your DM.");
    // notify creator
    try {
      await ctx.telegram.sendMessage(Number(post!.channel.ownerTgId),
        `ğŸ”“ ${post!.title ?? `Post #${postId}`} unlocked by @${ctx.from!.username ?? ctx.from!.id} â€” ${res.amount} ${res.token}\nTx: ${res.explorer}`);
    } catch {}
  });
}


â¸»

Thatâ€™s everything you need for paywalled text + video in KOL channels with clean UX and your fee model. Want me to also generate the /post_locked wizard (admin) file so you can paste it in next?